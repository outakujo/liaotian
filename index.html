<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>聊天</title>
    <script>
        const appHeight = function () {
            const doc = document.documentElement
            doc.style.setProperty("--app-height", `${window.innerHeight}px`)
        }
        window.addEventListener("resize", appHeight)
        appHeight()
    </script>
    <style>

        :root {
            --app-height: 100%;
        }

        body {
            height: 100vh;
            height: var(--app-height);
            width: 100vw;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            background: #f8f8f2;
        }

        input, textarea {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            border: none;
            border-bottom-style: solid;
            border-bottom-width: 0.2rem;
            border-bottom-color: #b9b6b6;
        }

        .app {
            width: 100%;
            text-align: center;
            margin: auto;
            flex-grow: 1;
        }

        .tab {
            width: 100%;
            display: flex;
            justify-content: space-between;
            margin: auto;
            font-size: 3.5rem;
            height: 8rem;
            align-items: center;
            border-top: 0.4rem;
            border-top-style: solid;
            border-top-color: #d5d4d4;
        }

        .tab div {
            margin: auto;
        }

        .lxr {
            display: flex;
            flex-direction: column;
            overflow-y: scroll;
        }

        .msg_list {
            display: flex;
            flex-direction: column;
            overflow-y: scroll;
        }

        .lxr_item {
            margin-top: 1rem;
            border-bottom-style: solid;
            border-bottom-left-radius: 1rem;
            border-bottom-right-radius: 1rem;
            border-bottom-color: #b9b6b6;
            display: flex;
        }

        .lxr_item_name {
            flex-grow: 1;
            text-align: left;
            padding-left: 2rem;
            margin: auto;
            font-size: 3rem;
        }

        .lxr_item_remove {
            color: red;
            font-size: 2.6rem;
            align-content: center;
            margin-right: 2rem;
        }

        .lxr_item_msg {
            flex-grow: 3;
            text-align: left;
            padding-left: 2rem;
            margin: auto;
            font-size: 2.4rem;
        }

        .lxr_item_pic {
            padding: 0.8rem;
        }

        .lxr_item_pic img {
            width: 6rem;
            height: 6rem;
        }

        .liaotian {
            display: flex;
            flex-direction: column;
            overflow-y: scroll;
        }

        .liaotian_send {
            width: 100%;
            display: flex;
            justify-content: space-between;
            margin: auto;
            font-size: 2rem;
            height: 6rem;
            align-items: center;
        }

        .liaotian_top {
            width: 100%;
            display: flex;
            font-size: 3rem;
            height: 6rem;
            border: none;
            border-bottom-style: solid;
            border-bottom-width: 0.2rem;
            border-bottom-color: #b9b6b6;
        }

        .liaotian_back {
            width: 10rem;
            text-align: start;
            padding-left: 1rem;
            align-content: center;
        }

        .liaotian_top_name {
            flex-grow: 1;
            text-align: start;
            align-content: center;
            padding-left: 2rem;
        }

        .liaotian_send textarea {
            width: 80%;
            height: 100%;
        }

        .liaotian_send button {
            width: 20%;
            height: 100%;
            background: greenyellow;
            font-size: 2rem;
            border: none;
            border-radius: 1rem;
        }

        .liaotian_msg {
            flex-grow: 1;
            font-size: 2.3rem;
            width: 100%;
            overflow-y: scroll;
        }

        .liaotian_msg_time {
            margin-top: 1rem;
            margin-bottom: 1rem;
        }

        .liaotian_msg_recv {
            background: greenyellow;
            width: 26rem;
            text-align: left;
            margin-right: auto;
            padding: 1rem;
            margin-top: 2rem;
            margin-left: 1rem;
        }

        .liaotian_msg_send {
            background: greenyellow;
            width: 26rem;
            text-align: left;
            margin-left: auto;
            padding: 1rem;
            margin-top: 2rem;
            margin-right: 1rem;
        }


        .login {
            width: 100%;
            text-align: center;
            margin: auto;
        }

        .login_item {
            font-size: 1.5rem;
            align-content: center;
        }

        .login input {
            height: 4rem;
            width: 20rem;
        }

        .login_btn {
            font-size: 1.5rem;
            background: greenyellow;
            border: none;
            border-radius: 0.2rem;
            height: 3.2rem;
            width: 8rem;
            margin-top: 0.5rem;
        }

        .my {
            display: flex;
            flex-direction: column;
        }

        .my_info {
            margin-top: 1rem;
            border-bottom-style: solid;
            border-bottom-color: #b9b6b6;
            display: flex;
            height: 15rem;
        }

        .my_pic {
            padding: 1rem;
            margin-top: 2rem;
            margin-left: 2rem;
        }

        .my_pic img {
            border-radius: 1rem;
            width: 9rem;
            height: 9rem;
            margin-right: 3rem;
        }

        .exit {
            margin-top: 3rem;
            display: flex;
            flex-direction: column;
            font-size: 2.8rem;
            color: #3db2b2;
            border-top-style: solid;
            border-top-color: #e3e3e3;
        }

        .exit div {
            border-bottom-style: solid;
            border-bottom-color: #e3e3e3;
            height: 6rem;
            text-align: start;
            margin-bottom: 1rem;
            padding-left: 5rem;
            padding-top: 1rem;
        }

        .add_user {
            text-align: end;
            font-size: 5rem;
            height: 6rem;
            padding-right: 2rem;
            padding-bottom: 1rem;
            border-bottom-style: solid;
            border-bottom-color: #e3e3e3;
        }

        .hide {
            display: none;
        }

        .select {
            color: greenyellow;
        }

        .ly_icon {
            width: 6.5rem;
            height: 7rem;
            margin-right: 1rem;
            margin-left: 1rem;
            padding-bottom: 1rem;
        }

        .lyzz {
            left: 0;
            top: 0;
            bottom: 0;
            right: 0;
            position: fixed;
            z-index: 99999;
            background: rgba(0, 0, 0, 0.28);
        }

        .lyzz_content {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .lyztip {
            font-size: 3rem;
            color: #ffffff;
            text-align: center;
        }

        .lystop {
            padding-top: 5rem;
            text-align: center;
        }

        .lystop_icon {
            width: 7rem;
            height: 7rem;
            margin-right: 1rem;
            margin-left: 1rem;
        }

        .lycancel_icon {
            width: 6.2rem;
            height: 6.2rem;
            margin-right: 4rem;
            margin-left: 1rem;
        }

        .liaotian_msg_icon {
            width: 3rem;
            height: 3rem;
            margin-left: 0.7rem;
            margin-right: 0.7rem;
        }

        .liaotian_msg_send_audio {
            background: greenyellow;
            width: 26rem;
            flex-direction: row;
            display: flex;
            justify-content: right;
            padding: 1rem;
            margin-top: 2rem;
            margin-left: auto;
            margin-right: 1rem;
        }

        .liaotian_msg_recv_audio {
            background: greenyellow;
            width: 26rem;
            flex-direction: row;
            display: flex;
            justify-content: left;
            padding: 1rem;
            margin-top: 2rem;
            margin-right: auto;
            margin-left: 1rem;
        }

        .liaotian_msg_audio_txt {
            flex-grow: 1;
            text-align: center;
        }

    </style>
</head>
<body>

<div id="login" class="login hide">
    <div class="login_item">
        用户：<input type="text" id="user_login">
    </div>
    <div class="login_item">
        密码：<input type="text" id="pass">
    </div>
    <div class="login_item">
        <button id="logi" class="login_btn">登录</button>
    </div>
</div>

<div id="liaotian" class="app liaotian hide">
    <div id="to_id" class="hide">
    </div>
    <div class="liaotian_top">
        <div class="liaotian_back" onclick="showUI('msg_list')">
            <
        </div>
        <div class="liaotian_top_name" id="liaotian_top_name">
        </div>
    </div>
    <div class="liaotian_msg" id="liaotian_msg">
    </div>
    <div class="liaotian_send">
        <svg class="ly_icon" onclick="openLyzz()" viewBox="0 0 1024 1024"
             xmlns="http://www.w3.org/2000/svg" p-id="2881">
            <path d="M488.727273 930.909091v-93.905455a325.934545 325.934545 0 0 1-280.832-207.825454A325.073455 325.073455 0 0 1 186.181818 512h46.545455c0 34.792727 6.353455 68.677818 18.594909 100.421818A279.365818 279.365818 0 0 0 791.272727 512h46.545455c0 40.494545-7.400727 80.011636-21.643637 117.038545A325.934545 325.934545 0 0 1 535.272727 837.003636V930.909091h186.181818v46.545454H302.545455v-46.545454h186.181818z m23.272727-837.818182a186.181818 186.181818 0 0 0-186.181818 186.181818v232.727273a186.181818 186.181818 0 1 0 372.363636 0V279.272727a186.181818 186.181818 0 0 0-186.181818-186.181818z m0-46.545454c128.535273 0 232.727273 104.192 232.727273 232.727272v232.727273c0 128.535273-104.192 232.727273-232.727273 232.727273s-232.727273-104.192-232.727273-232.727273V279.272727c0-128.535273 104.192-232.727273 232.727273-232.727272z"
                  fill="#6D7793" id="ly_icon"></path>
        </svg>
        <textarea id="msg"></textarea>
        <button id="send" onclick="sendMsg()">发送</button>
    </div>
</div>

<div id="lxr" class="app lxr hide">
</div>

<div id="msg_list" class="app msg_list hide">
    <div class="add_user" onclick="addLxr()">
        +
    </div>
</div>

<div id="my" class="app my hide">
    <div class="my_info">
        <div class="my_pic">
            <img src="tx.jpg">
        </div>
        <div id="my_name" class="lxr_item_name">
        </div>
    </div>
    <div class="exit">
        <div onclick="exit()">退出</div>
    </div>
</div>

<div id="tab" class="tab hide">
    <div id="msg_tab" onclick="showUI('msg_list')">消息</div>
    <div id="lxr_tab" onclick="showUI('lxr')">联系人</div>
    <div id="my_tab" onclick="showUI('my')">我的</div>
</div>

<div id="lyzz" class="lyzz hide">
    <div class="lyzz_content">
        <div class="lyztip">
            录音中...
        </div>
        <div class="lystop">
            <div>
                <svg viewBox="0 0 1024 1024" class="lycancel_icon"
                     xmlns="http://www.w3.org/2000/svg" p-id="6233"
                     onclick="cancelLy()">
                    <path d="M97.1 91.2c11.3-11.3 29.8-11.3 41.1 0l782.2 782.2c11.3 11.3 11.3 29.8 0 41.1s-29.8 11.3-41.1 0L97.1 132.2c-11.3-11.3-11.3-29.7 0-41z"
                          fill="red" p-id="6234"></path>
                    <path d="M920.4 91.1c11.3 11.3 11.3 29.8 0 41.1L138.2 914.5c-11.3 11.3-29.8 11.3-41.1 0s-11.3-29.8 0-41.1L879.3 91.1c11.4-11.3 29.8-11.3 41.1 0z"
                          fill="red" p-id="6235"></path>
                </svg>
                <svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="lystop_icon"
                     onclick="closeLyzz()">
                    <path d="M915.515273 142.819385 98.213046 458.199122c-46.058539 17.772838-44.90475 43.601756 2.348455 57.622994l197.477685 58.594874 80.292024 238.91085c10.51184 31.277988 37.972822 37.873693 61.462483 14.603752l103.584447-102.611545 204.475018 149.840224c26.565749 19.467242 53.878547 9.222132 61.049613-23.090076l149.210699-672.34491C965.264096 147.505054 946.218922 130.971848 915.515273 142.819385zM791.141174 294.834331l-348.61988 310.610267c-6.268679 5.58499-11.941557 16.652774-12.812263 24.846818l-15.390659 144.697741c-1.728128 16.24808-7.330491 16.918483-12.497501 1.344894l-67.457277-203.338603c-2.638691-7.954906 0.975968-17.705389 8.022355-21.931178l442.114555-265.181253C812.67481 268.984974 815.674251 272.975713 791.141174 294.834331z"
                          fill="#56d530"></path>
                </svg>
            </div>
        </div>
    </div>
</div>

<audio id="tip_audio" class="hide">
    <source src="tip.wav" type="audio/wav">
</audio>

<script>

    let urlContext = "localhost:3000"
    let enableWss = false
    let tokenKey = "token"
    let usernameKey = "username"
    let AuthorizationKey = "Authorization"
    let socket = null
    let record = null
    let incr = 0
    let player = new Audio()

    const MsgTxtType = 1
    const MsgAudioType = 2

    function getCookie(k) {
        let sps = document.cookie.split(";")
        for (let i = 0; i < sps.length; i++) {
            let s = sps[i]
            sp = s.split("=")
            let key = String(sp[0]).trim()
            let value = String(sp[1]).trim()
            if (key == k) {
                return value
            }
        }
        return ""
    }

    function setCookie(k, v) {
        document.cookie = k + "=" + v
    }

    function toYMD(date) {
        var DD = String(date.getDate()).padStart(2, '0'); // 获取日
        var MM = String(date.getMonth() + 1).padStart(2, '0'); //获取月份，1 月为 0
        var yyyy = date.getFullYear(); // 获取年
        hh = String(date.getHours()).padStart(2, '0');       //获取当前小时数(0-23)
        mm = String(date.getMinutes()).padStart(2, '0');     //获取当前分钟数(0-59)
        ss = String(date.getSeconds()).padStart(2, '0');     //获取当前秒数(0-59)
        return yyyy + '-' + MM + '-' + DD + ' ' + hh + ':' + mm + ':' + ss;
    }

    function numberToMs(t) {
        let sec = t % 60
        let mm = parseInt(t / 60)
        let secstr = ""
        let mmstr = ""
        if (sec != 0) {
            secstr = sec + `"`
        }
        if (mm != 0) {
            mmstr = mm + `'`
        }
        return mmstr + secstr
    }

    function saveMsg(msg) {
        let ln = localStorage.length
        localStorage.setItem(`message_${ln}`, JSON.stringify(msg))
    }

    function getMsg(name) {
        let ar = []
        let ln = localStorage.length
        for (let i = 0; i < ln; i++) {
            let k = localStorage.key(i)
            if (!k.includes("message_")) {
                continue
            }
            let it = localStorage.getItem(k)
            let obj = JSON.parse(it)
            if (name == obj.fromId || name == obj.toId) {
                ar.push(obj)
            }
        }
        ar.sort(function (a, b) {
            return a.time - b.time
        })
        return ar
    }

    function showUI(name) {
        let msg_list = document.getElementById("msg_list")
        let lxr = document.getElementById("lxr")
        let login = document.getElementById("login")
        let liaotian = document.getElementById("liaotian")
        let my = document.getElementById("my")
        let tab = document.getElementById("tab")
        let msg_tab = document.getElementById("msg_tab")
        let lxr_tab = document.getElementById("lxr_tab")
        let my_tab = document.getElementById("my_tab")
        let hideClass = "hide"
        let selectClass = "select"
        login.classList.add(hideClass)
        msg_list.classList.add(hideClass)
        lxr.classList.add(hideClass)
        liaotian.classList.add(hideClass)
        my.classList.add(hideClass)
        tab.classList.remove(hideClass)
        msg_tab.classList.remove(selectClass)
        lxr_tab.classList.remove(selectClass)
        my_tab.classList.remove(selectClass)
        let sps = name.split("?")
        let pam = new Map()
        if (sps.length != 1) {
            name = sps[0]
            let sp = sps[1]
            let nsp = sp.split("&")
            for (let i = 0; i < nsp.length; i++) {
                let s = nsp[i].split("=")
                pam.set(s[0], s[1])
            }
        }
        let refmsg = function () {
            let liaotian_msg = document.getElementById("liaotian_msg")
            liaotian_msg.innerHTML = ""
            let msg_txt = document.getElementById("msg")
            msg_txt.value = ""
            let mgs = getMsg(pam.get("name"))
            for (let i = 0; i < mgs.length; i++) {
                refreshLiaotian(mgs[i])
            }
        }

        switch (name) {
            case "login":
                login.classList.remove(hideClass)
                tab.classList.add(hideClass)
                break
            case "msg_list":
                msg_list.classList.remove(hideClass)
                msg_tab.classList.add(selectClass)
                playReset()
                break
            case "lxr":
                lxr.classList.remove(hideClass)
                lxr_tab.classList.add(selectClass)
                lxrList()
                break
            case "liaotian":
                let to_id = document.getElementById("to_id")
                to_id.innerText = pam.get("name")
                let liaotian_top_name = document.getElementById("liaotian_top_name")
                liaotian_top_name.innerText = pam.get("name")
                liaotian.classList.remove(hideClass)
                tab.classList.add(hideClass)
                refmsg()
                break
            case "my":
                let username = getCookie(usernameKey)
                let my_name = document.getElementById("my_name")
                my_name.innerText = username
                my.classList.remove(hideClass)
                my_tab.classList.add(selectClass)
                break
        }
    }

    function openLxr(name) {
        showUI("liaotian?name=" + name)
    }

    function sendMsg() {
        sendTypeMsg(MsgTxtType)
    }

    function sendTypeMsg(contentType, content) {
        if (!socket) {
            return
        }
        let to_id = document.getElementById("to_id")
        let toId = to_id.innerText.trim()
        if (toId == "") {
            alert("toId是空")
            return
        }
        let fromId = getCookie(usernameKey)
        if (fromId == "") {
            alert("fromId是空")
            return
        }
        if (contentType == MsgTxtType) {
            let msg = document.getElementById("msg")
            content = msg.value
            if (content == "") {
                return
            }
            msg.value = ""
        }
        let sm = {
            fromId: fromId,
            toId: toId,
            content: content,
            contentType: contentType,
            time: parseInt(new Date().getTime() / 1000)
        }
        try {
            socket.send(JSON.stringify(sm))
            saveMsg(sm)
            refreshLiaotian(sm)
        } catch (e) {
            alert("发送失败")
        }
    }

    function refreshMsgList(msg) {
        let msg_list = document.getElementById("msg_list")
        let apdv = document.getElementById(msg.fromId)
        if (!apdv) {
            apdv = document.createElement("div")
            apdv.id = msg.fromId
            apdv.className = "lxr_item"
            msg_list.appendChild(apdv)
            apdv.onclick = function () {
                showUI('liaotian?name=' + msg.fromId)
            }
        }
        if (msg.contentType == MsgAudioType) {
            msg.content = "[语音]"
        }
        apdv.innerHTML = `<div class="lxr_item_pic">
            <img src="tx.jpg">
        </div>
        <div class="lxr_item_name">
            ${msg.fromId}
        </div>
        <div class="lxr_item_msg">
            ${msg.content}
        </div>`
    }

    function refreshLiaotian(msg) {
        let liaotian_msg = document.getElementById("liaotian_msg")
        if (msg.fromId == getCookie(usernameKey)) {
            let sedv = document.createElement("div")
            if (msg.contentType == MsgAudioType) {
                let aur = msg.content
                msg.content = numberToMs(aur.split("_")[1].split(".")[0])
                sedv.innerHTML = ` <div class="liaotian_msg_audio_txt">
                ${msg.content}
            </div>
            <svg class="liaotian_msg_icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg"
                 p-id="9165">
                <path d="M726.00008 278.63235C744.200233 263.712153 772.345514 264.967496 788.85453 281.457133 805.345962 297.946772 803.964091 323.430758 785.74532 338.387723 744.054392 372.623393 720.127128 421.632191 720.127128 472.819718 720.127128 523.933709 744.109213 572.979274 785.963566 607.326297 795.672865 615.284856 800.581818 626.216319 800.581818 637.203459 800.581818 646.842812 796.781673 656.5557 789.03554 664.274746 772.526524 680.747575 744.381243 682.002918 726.18109 667.044903 665.781117 617.427868 631.126767 546.647538 631.126767 472.819718 631.127799 398.900505 665.709746 328.121225 726.00008 278.63235L726.00008 278.63235 726.00008 278.63235ZM557.309402 145.824424C574.636576 130.036516 602.800475 129.944072 620.218671 145.658445 637.654452 161.318191 637.709271 186.892521 620.400714 202.66257 541.254459 274.772829 497.637599 370.703088 497.637599 472.818669 497.637599 574.750413 541.310313 670.662814 620.61896 742.902284 629.237036 750.750541 633.564692 761.035949 633.564692 771.302447 633.564692 781.643532 629.200834 792.022434 620.455534 799.869641 603.019754 815.584013 574.873438 815.510479 557.52868 799.721521 461.509323 712.303432 408.637237 596.18999 408.637237 472.818669 408.636202 349.245652 461.454503 233.113301 557.309402 145.824424L557.309402 145.824424 557.309402 145.824424ZM390.072998 12.3904C407.073323-3.656979 435.236187-4.192733 452.981233 11.2275 470.744897 26.646683 471.309644 52.166387 454.290701 68.213766 338.763791 177.310944 275.163586 320.993608 275.163586 472.801859 275.163586 624.314921 338.872396 767.942959 454.508945 877.262842 462.762935 885.055423 466.890966 895.100267 466.890966 905.146161 466.890966 915.726759 462.308864 926.326265 453.181894 934.248057 435.454432 949.648328 407.272949 949.094717 390.255042 933.029478 258.653535 808.641282 186.181841 645.217695 186.181841 472.819719 186.145638 300.088735 258.581132 136.591611 390.072998 12.3904L390.072998 12.3904 390.072998 12.3904Z"
                      fill="#283F52" p-id="9166"></path>
            </svg>`
                sedv.className = "liaotian_msg_send_audio"
                sedv.setAttribute("audio", aur)
                sedv.onclick = function () {
                    player.load()
                    player.src = aur
                    player.play()
                }
            } else {
                sedv.innerHTML = `${msg.content}`
                sedv.className = "liaotian_msg_send"
            }
            liaotian_msg.appendChild(sedv)
            return
        }
        let ti = toYMD(new Date(msg.time * 1000))
        let tidv = document.createElement("div")
        tidv.innerHTML = `${ti}`
        tidv.className = "liaotian_msg_time"
        liaotian_msg.appendChild(tidv)
        let redv = document.createElement("div")
        if (msg.contentType == MsgAudioType) {
            let aur = msg.content
            msg.content = numberToMs(aur.split("_")[1].split(".")[0])
            redv.innerHTML = `<svg class="liaotian_msg_icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg"
                 p-id="9459">
                <path d="M261.283306 278.655388C243.083715 263.735652 214.939304 264.990956 198.430798 281.480084 181.939876 297.969213 183.321704 323.452412 201.539912 338.408914 243.229552 372.643525 267.156076 421.650809 267.156076 472.836754 267.156076 523.949165 243.174733 572.993214 201.321674 607.339176 191.612674 615.297489 186.703873 626.228613 186.703873 637.215414 186.703873 646.854469 190.503901 656.567057 198.249794 664.285864 214.758299 680.758184 242.902711 682.013488 261.102301 667.055936 321.500408 617.440435 356.153686 546.662292 356.153686 472.836754 356.152655 398.919826 321.571777 328.142733 261.283306 278.655388L261.283306 278.655388 261.283306 278.655388ZM429.96877 145.851566C412.642132 130.064147 384.479103 129.971706 367.061445 145.685593 349.626204 161.344855 349.571386 186.918394 366.879407 202.687956 446.023217 274.795986 489.638728 370.72328 489.638728 472.835705 489.638728 574.764298 445.967364 670.673735 366.661169 742.910972 358.043359 750.758987 353.715837 761.044077 353.715837 771.310258 353.715837 781.651023 358.07956 792.029604 366.82459 799.876569 384.259831 815.590455 412.405277 815.516923 429.749498 799.728453 525.765888 712.313066 578.63634 596.203213 578.63634 472.835705 578.637375 349.266508 525.820707 233.137746 429.96877 145.851566L429.96877 145.851566 429.96877 145.851566ZM597.200005 12.421667C580.200206-3.625216 552.038212-4.160954 534.293714 11.258803 516.530599 26.677509 515.965869 52.196424 532.984287 68.243307 648.507626 177.337114 712.105866 321.015336 712.105866 472.818896 712.105866 624.327274 648.399024 767.950874 532.766049 877.267378 524.512314 885.059717 520.384411 895.104251 520.384411 905.149835 520.384411 915.730105 524.966372 926.329284 534.093059 934.250831 551.819973 949.650626 580.000586 949.097032 597.017967 933.03229 728.615406 808.647938 801.08486 645.229403 801.08486 472.836754 801.121061 300.11111 728.687807 136.619039 597.200005 12.421667L597.200005 12.421667 597.200005 12.421667Z"
                      fill="#283F52" p-id="9460"></path>
            </svg>
            <div class="liaotian_msg_audio_txt">
                ${msg.content}
            </div>`
            redv.className = "liaotian_msg_recv_audio"
            redv.setAttribute("audio", aur)
            redv.onclick = function () {
                player.load()
                player.src = aur
                player.play()
            }
        } else {
            redv.innerHTML = `${msg.content}`
            redv.className = "liaotian_msg_recv"
        }
        liaotian_msg.appendChild(redv)
    }

    function initLiaotian() {
        showUI('msg_list')
        let wsDo = "ws://"
        if (enableWss) {
            wsDo = "wss://"
        }
        let url = wsDo + urlContext + "/liaotian"
        let tipAudio = document.getElementById("tip_audio")
        let openSoc = function () {
            console.log("open")
        }
        let closeSoc = function (connectSoc) {
            return function () {
                console.log("close")
                setTimeout(function () {
                    console.log("connect retry")
                    connectSoc()
                }, 2000)
            }
        }
        let onMessage = function (event) {
            if (!event.data) {
                return
            }
            let msg = JSON.parse(event.data)
            saveMsg(msg)
            refreshMsgList(msg)
            refreshLiaotian(msg)
            tipAudio.load()
            tipAudio.play()
        }
        let connectSoc = function () {
            socket = new WebSocket(url, ["Sec-Websocket-Protocol",
                encodeURIComponent(getCookie(tokenKey))]);
            socket.onopen = openSoc
            socket.onmessage = onMessage
            socket.onclose = closeSoc(connectSoc)
        }
        connectSoc()
    }

    function initLogin() {
        showUI('login')
        let lgBtn = document.getElementById("logi")
        let user = document.getElementById("user_login")
        let pa = document.getElementById("pass")
        lgBtn.onclick = function () {
            if (user.value == "") {
                alert("用户不能为空")
                return
            }
            if (pa.value == "") {
                alert("密码不能为空")
                return
            }
            let url = urlContext + "/login"
            let xhr = new XMLHttpRequest()
            xhr.open("POST", url)
            let formData = new FormData()
            formData.append("name", user.value)
            formData.append("pass", pa.value)
            xhr.onload = function () {
                let resp = JSON.parse(xhr.responseText)
                if (xhr.status != 200 || resp.code != 0) {
                    alert(resp.msg)
                    return
                }
                setCookie(usernameKey, user.value)
                setCookie(tokenKey, "Bearer " + resp.data.token)
                location.reload();
            }
            xhr.onerror = function (e) {
                alert(e)
            }
            xhr.send(formData)
        }
    }

    function exit() {
        document.cookie = `${tokenKey}=; expires=Thu, 01 Jan 1970 00:00:00 UTC;`
        document.cookie = `${usernameKey}=; expires=Thu, 01 Jan 1970 00:00:00 UTC;`
        localStorage.clear()
        location.reload()
    }

    function addLxr() {
        let userId = prompt("请输入好友id")
        if (userId == null || userId == "") {
            return
        }
        let url = urlContext + "/lxr"
        let xhr = new XMLHttpRequest()
        xhr.open("POST", url)
        xhr.setRequestHeader(AuthorizationKey, getCookie(tokenKey))
        let formData = new FormData()
        formData.append("id", userId)
        xhr.onload = function () {
            let resp = JSON.parse(xhr.responseText)
            if (xhr.status != 200 || resp.code != 0) {
                alert(resp.msg)
            } else {
                alert("添加成功")
                lxrList()
            }
        }
        xhr.send(formData)
    }

    function lxrList() {
        let ls = []
        let url = urlContext + "/lxr/list"
        let xhr = new XMLHttpRequest()
        xhr.open("GET", url, false)
        xhr.setRequestHeader(AuthorizationKey, getCookie(tokenKey))
        xhr.onload = function () {
            if (xhr.status == 403) {
                exit()
            }
            let resp = JSON.parse(xhr.responseText)
            if (xhr.status != 200 || resp.code != 0) {
                alert(resp.msg)
                return
            }
            ls = resp.data
        }
        xhr.send()
        let lxr = document.getElementById("lxr")
        lxr.innerHTML = ""
        for (let i = 0; i < ls.length; i++) {
            let name = ls[i]
            let apdv = document.createElement("div")
            apdv.className = "lxr_item"
            apdv.onclick = function () {
                return function () {
                    openLxr(name)
                }
            }()
            apdv.innerHTML = `<div class="lxr_item_pic">
                <img src="tx.jpg">
            </div>
            <div class="lxr_item_name">
                ${name}
            </div>`
            let deldv = document.createElement("div")
            deldv.className = "lxr_item_remove"
            deldv.innerHTML = "删除"
            deldv.onclick = function (e) {
                apdv.remove()
                e.stopPropagation()
                let url = urlContext + "/lxr?id=" + name
                let xhr = new XMLHttpRequest()
                xhr.open("DELETE", url)
                xhr.setRequestHeader(AuthorizationKey, getCookie(tokenKey))
                xhr.onload = function () {
                    if (xhr.status == 403) {
                        exit()
                    }
                    let resp = JSON.parse(xhr.responseText)
                    if (xhr.status != 200 || resp.code != 0) {
                        alert(resp.msg)
                    } else {
                        lxrList()
                    }
                }
                xhr.send()
            }
            apdv.appendChild(deldv)
            lxr.appendChild(apdv)
        }
    }

    function start() {
        if (getCookie(tokenKey) == "") {
            initLogin()
        } else {
            initLiaotian()
        }
    }

    function openLyzz() {
        playReset()
        let lyzz = document.getElementById("lyzz")
        lyzz.classList.remove("hide")
        if (!navigator.mediaDevices) {
            closeLyzz()
            alert("不支持录音")
            return
        }
        const constraints = {audio: true}
        let chunks = []
        navigator.mediaDevices.getUserMedia(constraints)
            .then(function (stream) {
                stream.stop = function () {
                    this.getAudioTracks().forEach(function (track) {
                        track.stop();
                    })
                }
                record = new MediaRecorder(stream)
                record.ondataavailable = function (e) {
                    chunks.push(e.data)
                }
                incr = 0
                let timer = setInterval(function () {
                    incr++
                    if (incr > 120) {
                        incr = 0
                        closeLyzz()
                        alert("最长时间2分钟")
                    }
                }, 1000)
                record.onstop = function (e) {
                    stream.stop()
                    clearInterval(timer)
                    if (incr == 0) {
                        return
                    }
                    let blob = new Blob(chunks, {type: "audio/ogg; codecs=opus"})
                    chunks = null
                    let url = urlContext + "/putaudio"
                    let putfile = new File([blob], "audio.ogg")
                    let formdata = new FormData()
                    formdata.append("time", incr)
                    formdata.append("file", putfile)
                    incr = 0
                    let xhr = new XMLHttpRequest()
                    xhr.open("POST", url)
                    xhr.setRequestHeader(AuthorizationKey, getCookie(tokenKey))
                    xhr.onload = function () {
                        if (xhr.status == 403) {
                            exit()
                        }
                        let resp = JSON.parse(xhr.responseText)
                        if (xhr.status != 200 || resp.code != 0) {
                            alert(resp.msg)
                            return
                        }
                        sendTypeMsg(MsgAudioType, urlContext + "/" + resp.data)
                    }
                    xhr.send(formdata)
                }
                record.start()
            }).catch(function (e) {
            alert(e)
        })
    }

    function closeLyzz() {
        let lyzz = document.getElementById("lyzz")
        lyzz.classList.add("hide")
        if (record) {
            record.stop()
        }
    }

    function cancelLy() {
        incr = 0
        closeLyzz()
    }

    function playReset() {
        player.load()
        player.src = ""
    }

    start()

</script>

</body>
</html>